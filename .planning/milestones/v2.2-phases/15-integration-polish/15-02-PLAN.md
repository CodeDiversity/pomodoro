---
phase: 15-integration-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/streakUtils.ts
  - src/services/sessionStore.ts
  - src/features/streak/streakSlice.ts
autonomous: true
requirements: []
must_haves:
  truths:
    - "Streak calculation handles timezone edge cases correctly"
    - "Streak data persists after app refresh"
    - "CSV import data persists after app refresh"
    - "Large imports (1000+ sessions) complete without UI freeze"
  artifacts:
    - path: "src/utils/streakUtils.ts"
      provides: "Streak calculation with timezone handling"
      contains: "date-fns.*format.*yyyy-MM-dd"
    - path: "src/services/sessionStore.ts"
      provides: "Session persistence to IndexedDB"
      contains: "saveSession|getAllSessions"
  key_links:
    - from: "src/features/streak/streakSlice.ts"
      to: "src/utils/streakUtils.ts"
      via: "import"
    - from: "src/components/Settings.tsx"
      to: "src/services/sessionStore.ts"
      via: "parseCsvFile"
---

<objective>
Verify streak timezone handling, persistence, and large file import performance.

Purpose: Confirm that all success criteria from phase goal are met - timezone edge cases work, persistence works, large imports don't freeze UI.
Output: Verified implementations with documented test approach.
</objective>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-integration-polish/15-CONTEXT.md
@.planning/phases/15-integration-polish/15-RESEARCH.md

# Key findings from research:
- Timezone handling: Already uses date-fns format() which correctly handles local timezone
- Batch processing: Already implemented with 50 session batches and 10ms delays
- Duplicate detection: Already implemented via startTimestamp matching
- Need to verify these work correctly in practice
</context>

<tasks>

<task type="auto">
  <name>Verify streak timezone handling implementation</name>
  <files>src/utils/streakUtils.ts</files>
  <action>
Review streakUtils.ts timezone implementation:

1. Confirm getTodayString() uses format(new Date(), 'yyyy-MM-dd') - uses local timezone
2. Confirm getYesterdayString() uses format(new Date(Date.now() - 86400000), 'yyyy-MM-dd')
3. Confirm groupSessionsByDay uses format(new Date(session.startTimestamp), 'yyyy-MM-dd')
4. Document that date-fns format() uses local timezone automatically

The implementation is already correct - document this in a comment for future reference.
  </action>
  <verify>
grep -n "format.*yyyy-MM-dd" src/utils/streakUtils.ts</verify>
  <done>Streak calculation uses date-fns format() which handles local timezone correctly</done>
</task>

<task type="auto">
  <name>Verify persistence layer for streak data</name>
  <files>src/features/streak/streakSlice.ts</files>
  <action>
Verify streak persistence is properly implemented:

1. Check that streakSlice has persistence middleware or explicit save calls
2. Check that loadStreak action exists to hydrate state on app start
3. Verify streakStore or equivalent abstraction saves to IndexedDB

Review the existing streak persistence implementation and confirm it works correctly.
  </action>
  <grep -n "saveStreak\|loadStreak\|persistence" src/features/streak/</grep>
  <done>Streak data saves to IndexedDB and loads on app start</done>
</task>

<task type="auto">
  <name>Verify large CSV import batch processing</name>
  <files>src/utils/csvImport.ts</files>
  <action>
Review csvImport.ts batch processing implementation:

1. Confirm batchSize = 50 sessions per batch
2. Confirm 10ms delay between batches (setTimeout)
3. Confirm all sessions in a batch are processed before delay
4. Document that this approach handles 1000+ sessions without freezing UI

The implementation is already correct - batches of 50 with 10ms delays yield to the event loop.
  </action>
  <verify>
grep -n "batchSize\|setTimeout" src/utils/csvImport.ts</verify>
  <done>CSV import processes in batches of 50 with 10ms delays, preventing UI freeze</done>
</task>

<task type="auto">
  <name>Verify duplicate session detection during import</name>
  <files>src/utils/csvImport.ts</files>
  <action>
Review duplicate detection implementation:

1. Confirm getExistingTimestamps() loads all session startTimestamps
2. Confirm parseCsvFile checks existingTimestamps.has(session.startTimestamp)
3. Confirm duplicates are skipped (not imported) and count is tracked
4. Per user decision: skip duplicates silently without notification

The implementation is already correct - duplicate detection happens via startTimestamp matching.
  </action>
  <verify>
grep -n "existingTimestamps\|skipped" src/utils/csvImport.ts | head -10</verify>
  <done>Duplicate sessions are detected and skipped during import</done>
</task>

</tasks>

<verification>
No code changes needed - this plan verifies existing implementations:

1. Review streakUtils.ts for timezone handling
2. Review streakSlice.ts for persistence
3. Review csvImport.ts for batch processing
4. Review csvImport.ts for duplicate detection
</verification>

<success_criteria>
1. Streak calculation uses date-fns (handles local timezone correctly)
2. Streak data persists via IndexedDB
3. CSV import uses batch processing (50 sessions, 10ms delays)
4. Duplicate sessions detected via startTimestamp matching
</success_criteria>

<output>
After completion, create `.planning/phases/15-integration-polish/15-02-SUMMARY.md`
</output>
