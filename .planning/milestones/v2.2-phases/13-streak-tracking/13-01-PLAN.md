---
phase: 13-streak-tracking
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/features/streak/streakSlice.ts
  - src/features/streak/streakSelectors.ts
  - src/features/streak/streakMiddleware.ts
  - src/features/streak/useStreak.ts
  - src/utils/streakUtils.ts
  - src/app/store.ts
autonomous: true
requirements:
  - STRK-01
  - STRK-02
  - STRK-03
  - STRK-06
  - STRK-07
user_setup: []
must_haves:
  truths:
    - "Current streak count displays in Stats view and updates after each session"
    - "Best (longest) streak is tracked and displayed"
    - "Streak increments only for sessions of 5+ minutes on consecutive days"
    - "Streak protection activates at 5+ day streaks (1 free miss)"
    - "Streak data persists to IndexedDB"
  artifacts:
    - path: "src/features/streak/streakSlice.ts"
      provides: "Redux state management for streak"
      exports: ["updateStreak", "loadStreak", "useProtection", "resetStreak"]
    - path: "src/features/streak/streakSelectors.ts"
      provides: "Memoized selectors for streak state"
      exports: ["selectCurrentStreak", "selectBestStreak", "selectProtectionUsed"]
    - path: "src/features/streak/streakMiddleware.ts"
      provides: "Debounced persistence to IndexedDB"
    - path: "src/utils/streakUtils.ts"
      provides: "Streak calculation logic"
      exports: ["groupSessionsByDay", "calculateStreaks"]
  key_links:
    - from: "streakSlice"
      to: "IndexedDB"
      via: "streakMiddleware"
      pattern: "debounced save on updateStreak action"
---

<objective>
Implement streak tracking Redux infrastructure with persistence and calculation logic.

Purpose: Enable streak tracking feature by creating Redux state management, IndexedDB persistence, and streak calculation utilities. This establishes the foundation for displaying streaks in the UI.

Output: streakSlice.ts, streakSelectors.ts, streakMiddleware.ts, useStreak.ts hook, streakUtils.ts, store.ts updated
</objective>

<execution_context>
@/Users/michaelrobert/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelrobert/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-streak-tracking/13-CONTEXT.md
@.planning/phases/13-streak-tracking/13-RESEARCH.md
@src/app/store.ts
@src/services/sessionStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install date-fns and react-icons dependencies</name>
  <files>package.json</files>
  <action>
    Run: npm install date-fns react-icons

    These are required by RESEARCH.md for date manipulation and icons.
  </action>
  <verify>npm list date-fns react-icons shows both packages installed</verify>
  <done>Dependencies available for import in TypeScript files</done>
</task>

<task type="auto">
  <name>Task 2: Create streak utilities for streak calculation</name>
  <files>src/utils/streakUtils.ts</files>
  <action>
    Create src/utils/streakUtils.ts with the following exports:

    1. `DailyActivity` interface: { date: string; sessionCount: number; totalSeconds: number }
    2. `groupSessionsByDay(sessions: SessionRecord[]): Map<string, DailyActivity>` - Groups completed sessions (actualDurationSeconds >= 300) by date (YYYY-MM-DD)
    3. `calculateStreaks(dailyActivity, currentStreak, bestStreak, lastActiveDate, protectionUsed)` - Returns new streak state with protection logic:
       - If no activity today/yesterday and daysSince > 1:
         - If currentStreak >= 5 && !protectionUsed: use protection (keep streak, set protectionUsed = true)
         - Else: reset streak to 0
       - If has activity today and lastActiveDate != today: increment streak
       - Always update bestStreak if current > best
       - Use local timezone for date calculations (format from date-fns)

    Reference RESEARCH.md for exact algorithm. Use date-fns format() for local date strings.
  </action>
  <verify>TypeScript compiles without errors, streakUtils.ts exports functions correctly</verify>
  <done>Streak calculation logic handles consecutive days, 5-min minimum, and streak protection</done>
</task>

<task type="auto">
  <name>Task 3: Create streak Redux slice</name>
  <files>src/features/streak/streakSlice.ts</files>
  <action>
    Create src/features/streak/streakSlice.ts following existing slice patterns (timerSlice, sessionSlice):

    1. `StreakState` interface:
       - currentStreak: number
       - bestStreak: number
       - lastActiveDate: string | null
       - protectionUsed: boolean
       - isLoaded: boolean
    2. Initial state: { currentStreak: 0, bestStreak: 0, lastActiveDate: null, protectionUsed: false, isLoaded: false }
    3. Reducers:
       - updateStreak(payload): Update all streak fields, set isLoaded = true
       - loadStreak(state): Load from persisted state
       - useProtection(): Set protectionUsed = true
       - resetStreak(): Reset to initial state
    4. Export actions: updateStreak, loadStreak, useProtection, resetStreak
    5. Export reducer as default
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>streakSlice.ts follows Redux Toolkit pattern and exports required actions</done>
</task>

<task type="auto">
  <name>Task 4: Create streak selectors</name>
  <files>src/features/streak/streakSelectors.ts</files>
  <action>
    Create src/features/streak/streakSelectors.ts:

    1. Selectors using createSelector:
       - selectCurrentStreak: state => state.streak.currentStreak
       - selectBestStreak: state => state.streak.bestStreak
       - selectLastActiveDate: state => state.streak.lastActiveDate
       - selectProtectionUsed: state => state.streak.protectionUsed
       - selectStreakLoaded: state => state.streak.isLoaded
       - selectHasProtection: currentStreak >= 5 && !protectionUsed (derived for UI)
    2. Export typed selectors using .withTypes<RootState>()
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>streakSelectors.ts exports memoized selectors for streak state</done>
</task>

<task type="auto">
  <name>Task 5: Create streak persistence middleware</name>
  <files>src/features/streak/streakMiddleware.ts</files>
  <action>
    Create src/features/streak/streakMiddleware.ts following timerPersistenceMiddleware pattern:

    1. Create streakPersistenceMiddleware using redux-middleware pattern
    2. On 'streak/updateStreak' action:
       - Debounce save to IndexedDB (use setTimeout with 500ms delay, cancel previous timeout)
       - Save to IndexedDB 'streak' store with { id: 'current', ...streakState }
    3. Export middleware
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>streakMiddleware.ts implements debounced persistence to IndexedDB</done>
</task>

<task type="auto">
  <name>Task 6: Create useStreak hook</name>
  <files>src/features/streak/useStreak.ts</files>
  <action>
    Create src/features/streak/useStreak.ts:

    1. Import { useAppDispatch, useAppSelector } from '../../app/hooks'
    2. Import selectors from streakSelectors
    3. Import { loadStreak, updateStreak } from streakSlice
    4. Import { groupSessionsByDay, calculateStreaks } from utils/streakUtils
    5. Import { getAllSessions } from services/sessionStore

    Hook returns:
    - currentStreak (from selector)
    - bestStreak (from selector)
    - protectionUsed (from selector)
    - hasProtection (derived, true if currentStreak >= 5 && !protectionUsed)
    - recalculateStreak: async function that:
      a. Gets all sessions from IndexedDB
      b. Groups by day using streakUtils
      c. Calls calculateStreaks with current state
      d. Dispatches updateStreak with new values
    - loadStreakFromStorage: async function that:
      a. Loads streak data from IndexedDB
      b. Dispatches loadStreak if data exists

    On mount: call loadStreakFromStorage, then recalculateStreak
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>useStreak hook provides streak data and recalculation functions</done>
</task>

<task type="auto">
  <name>Task 7: Wire streak into Redux store</name>
  <files>src/app/store.ts</files>
  <action>
    Update src/app/store.ts:

    1. Import streakReducer from '../features/streak/streakSlice'
    2. Import streakPersistenceMiddleware from '../features/streak/streakMiddleware'
    3. Add 'streak' to reducer config: streak: streakReducer
    4. Add streakPersistenceMiddleware to middleware chain using .prepend()
    5. Update comment header to document Phase 13 streak slice

    Follow existing pattern from timerPersistenceMiddleware and sessionPersistenceMiddleware.
  </action>
  <verify>TypeScript compiles without errors, build succeeds</verify>
  <done>Store configured with streak slice and persistence middleware</done>
</task>

</tasks>

<verification>
- [ ] npm run build succeeds without errors
- [ ] All streakSlice exports work correctly
- [ ] Middleware correctly debounces saves
- [ ] useStreak hook compiles and provides expected API
</verification>

<success_criteria>
- Streak Redux state management implemented (STRK-01, STRK-02, STRK-06)
- Streak calculation handles consecutive days with 5-min minimum (STRK-03)
- Streak data persists to IndexedDB (STRK-07)
- Streak recalculates on app load from session history (per CONTEXT.md)
</success_criteria>

<output>
After completion, create .planning/phases/13-streak-tracking/13-01-SUMMARY.md
</output>
