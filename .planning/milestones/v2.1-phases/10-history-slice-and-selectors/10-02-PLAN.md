---
phase: 10-history-slice-and-selectors
plan: '02'
type: execute
wave: 2
depends_on:
  - 10-history-slice-and-selectors-01
files_modified:
  - src/features/history/historySelectors.ts
  - src/features/history/useSessionHistory.ts
  - src/hooks/useSessionHistory.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Filtered sessions computed via memoized createSelector"
    - "Stats computed via memoized createSelector"
    - "useSessionHistory hook maintains same API - components unchanged"
    - "No unnecessary re-renders when unrelated state changes"
  artifacts:
    - path: "src/features/history/historySelectors.ts"
      provides: "Memoized selectors for filtered sessions and stats"
      exports: ["selectDateFilter", "selectSearchQuery", "selectAllSessions", "selectFilteredSessions", "selectStats", "selectLongestSession"]
    - path: "src/features/history/useSessionHistory.ts"
      provides: "Hook maintaining same API as original useSessionHistory"
      exports: ["useSessionHistory"]
  key_links:
    - from: "src/features/history/useSessionHistory.ts"
      to: "src/features/history/historySelectors.ts"
      via: "useAppSelector with createSelector"
      pattern: "useAppSelector\\(selectFilteredSessions\\)"
---

<objective>
Create memoized selectors for filtered sessions and stats, then refactor useSessionHistory hook to use Redux while maintaining the same API.
</objective>

<execution_context>
@/Users/dev/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/10-history-slice-and-selectors/10-RESEARCH.md
@src/hooks/useSessionHistory.ts
@src/utils/dateUtils.ts
@src/utils/statsUtils.ts
@src/services/sessionStore.ts
</context>

<tasks>

<task type="auto">
  <name>Create memoized historySelectors.ts</name>
  <files>src/features/history/historySelectors.ts</files>
  <action>
Create src/features/history/historySelectors.ts with memoized selectors using createSelector:

1. Import createSelector from '@reduxjs/toolkit', RootState from store, SessionRecord, getDateRange, calculateStats

2. Create base selectors:
   - selectDateFilter: state => state.history.dateFilter
   - selectSearchQuery: state => state.history.searchQuery
   - selectAllSessions: state => state.history.sessions
   - selectIsLoading: state => state.history.isLoading

3. Create memoized selectors using createSelector:

   selectSessionsByDate:
   - Input: [selectAllSessions, selectDateFilter]
   - If dateFilter is 'all', return all sessions
   - Otherwise, use getDateRange() to filter by date

   selectFilteredSessions:
   - Input: [selectSessionsByDate, selectSearchQuery]
   - If searchQuery is empty, return sessionsByDate
   - Otherwise, filter by matching noteText or tags (case-insensitive)

   selectStats:
   - Input: [selectSessionsByDate]
   - Return calculateStats(sessionsByDate)

   selectLongestSession:
   - Input: [selectSessionsByDate]
   - Return max actualDurationSeconds, or 0 if empty

4. Export all selectors

This follows the research pattern for memoized selectors with proper input/output separation.
  </files>
  <verify>
- TypeScript compiles: `npx tsc --noEmit` passes
- All selectors export correctly
- createSelector properly memoizes (same inputs return cached result)
  </verify>
  <done>
- historySelectors.ts created with all memoized selectors
- Selectors properly use createSelector for memoization
- Base selectors extract state correctly
  </done>
</task>

<task type="auto">
  <name>Create useSessionHistory hook with Redux</name>
  <files>src/features/history/useSessionHistory.ts</files>
  <action>
Create src/features/history/useSessionHistory.ts that maintains the same API as the original hook:

1. Import from app/hooks: useAppDispatch, useAppSelector
2. Import actions from historySlice: setDateFilter, setSearchQuery, loadSessions
3. Import selectors from historySelectors: selectFilteredSessions, selectAllSessions, selectDateFilter, selectSearchQuery, selectStats, selectLongestSession, selectIsLoading
4. Import from services/sessionStore: getAllSessions

5. Create UseSessionHistoryReturn interface matching original:
   ```typescript
   interface UseSessionHistoryReturn {
     sessions: SessionRecord[]
     filteredSessions: SessionRecord[]
     dateFilter: DateFilter
     searchQuery: string
     setDateFilter: (filter: DateFilter) => void
     setSearchQuery: (query: string) => void
     isLoading: boolean
     refetch: () => Promise<void>
     stats: {
       totalFocusTimeToday: number
       totalFocusTimeLast7Days: number
       sessionsToday: number
       longestSession: number
     }
     longestSessionInRange: number
   }
   ```

6. Implement hook:
   - Use useAppSelector for: allSessions, filteredSessions, dateFilter, searchQuery, stats, longestSessionInRange, isLoading
   - Use useAppDispatch to dispatch setDateFilter, setSearchQuery, loadSessions
   - Create fetchSessions function that calls getAllSessions(), sorts by date descending, dispatches loadSessions
   - Use useEffect to call fetchSessions on mount
   - Wrap setDateFilter and setSearchQuery in useCallback for stable references

7. Keep debounce in this hook (200ms) for search - dispatch setSearchQuery immediately but filter happens through selector

Return the same shape as the original useSessionHistory hook for backward compatibility.
  </files>
  <verify>
- TypeScript compiles without errors
- API matches original: same return shape, same parameter types
- Uses Redux selectors correctly
  </verify>
  <done>
- useSessionHistory hook created at src/features/history/useSessionHistory.ts
- API matches original hook exactly
- Uses Redux for state, selectors for computed data
  </done>
</task>

<task type="auto">
  <name>Update imports in components using useSessionHistory</name>
  <files>src/hooks/useSessionHistory.ts</files>
  <action>
Update src/hooks/useSessionHistory.ts to re-export from the new Redux-based hook:

1. Replace the entire file content with a re-export:
   ```typescript
   export { useSessionHistory } from '../features/history/useSessionHistory'
   ```

This maintains backward compatibility for any components importing from the old location.
The actual implementation is now in features/history/useSessionHistory.ts.
  </files>
  <verify>
- TypeScript compiles without errors
- Components importing from src/hooks/useSessionHistory still work
  </verify>
  <done>
- src/hooks/useSessionHistory.ts re-exports from features/history
- Backward compatibility maintained for existing imports
  </done>
</task>

</tasks>

<verification>
- [ ] historySelectors.ts created with all memoized selectors
- [ ] useSessionHistory hook in features/history maintains same API
- [ ] src/hooks/useSessionHistory.ts re-exports for backward compatibility
- [ ] TypeScript compiles without errors
- [ ] Build succeeds with no warnings
- [ ] Components using useSessionHistory require no changes
</verification>

<success_criteria>
- Filtered sessions computed via memoized selector (createSelector)
- Stats (today time, 7-day time, sessions today, longest) computed via selectors
- useSessionHistory hook maintains same API - components require no changes
- No unnecessary re-renders when unrelated state changes (selectors memoize properly)
- Date filter managed in Redux
- Search query managed in Redux
</success_criteria>

<output>
After completion, create `.planning/phases/10-history-slice-and-selectors/10-02-SUMMARY.md`
</output>
