---
wave: 1
depends_on: []
autonomous: true
phase: 22-polish-validation
plan: "01"
type: execute
requirements:
  - RTE-01
  - RTE-04
  - RTE-05
  - RTD-01
  - RTD-02
  - RTD-03
  - RTD-04
  - RTD-05
  - RTD-06
  - INF-01
  - INF-02
  - INF-03
must_haves:
  truths:
    - "Cmd/Ctrl+B toggles bold in editor"
    - "Links open in new tab with security attributes"
    - "Legacy plain-text notes render correctly"
    - "Character limit works with HTML content"
    - "All v2.3 features functional end-to-end"
  artifacts:
    - path: "src/components/RichTextEditor.tsx"
    - path: "src/utils/sanitize.ts"
    - path: "src/hooks/useSessionNotes.ts"
  key_links:
    - from: "RichTextEditor"
      to: "sanitize"
      via: "HTML sanitization"
files_modified:
  - src/components/RichTextEditor.tsx
  - src/utils/sanitize.ts
  - src/hooks/useSessionNotes.ts
---

# Phase 22: Polish & Validation

**Phase:** 22
**Goal:** Final integration verification, keyboard shortcuts, and edge case handling

## Overview

Phase 22 is a verification and polish phase for the v2.3 Rich Text Notes milestone. Most functionality has been implemented in previous phases (18-21), and this phase focuses on:
1. Verifying keyboard shortcuts work correctly
2. Ensuring link security attributes are properly applied
3. Confirming legacy plain-text notes render correctly
4. Validating character limit behavior with HTML content
5. Performing end-to-end browser testing

## Success Criteria (must_haves)

| # | Criteria | Verification Method |
|---|----------|---------------------|
| 1 | Cmd/Ctrl+B keyboard shortcut toggles bold in editor | Manual browser test |
| 2 | Links rendered in modal open in new tab with proper security attributes | Code review + manual test |
| 3 | Legacy plain-text notes (pre-v2.3) render without HTML artifacts | Manual test with old data |
| 4 | Character limit validation works correctly with HTML content | Code review + manual test |
| 5 | All v2.3 features functional in a clean browser test | End-to-end testing |

## Tasks

### Wave 1: Verification and Fixes

<task>

<name>Verify and fix keyboard shortcut (Cmd/Ctrl+B)</name>

<action>Verify that the Cmd/Ctrl+B keyboard shortcut works in the Tiptap rich text editor to toggle bold formatting. If not working, investigate and fix.</action>

<verify>
- Start a focus session
- Type text in the NotePanel editor
- Press Cmd+B (Mac) or Ctrl+B (Windows)
- Verify text becomes bold
- Press Cmd+B again to toggle bold off
- Bold is removed from text
</verify>

<done>Cmd/Ctrl+B keyboard shortcut toggles bold in editor</done>

<files>
- src/components/RichTextEditor.tsx
</files>

<dependencies></dependencies>

</task>

<task>

<name>Verify and fix link security attributes</name>

<action>Verify that links in the session summary modal and history drawer open in a new tab with proper security attributes (rel="noopener noreferrer"). Add target="_blank" if missing.</action>

<verify>
- Create a session with a link in the note
- Complete the session to open the summary modal
- Click the link in the modal
- Verify it opens in a new tab
- Inspect the HTML to confirm rel="noopener noreferrer nofollow" is present
</verify>

<done>Links rendered in modal open in new tab with proper security attributes</done>

<files>
- src/components/RichTextEditor.tsx
- src/utils/sanitize.ts
</files>

<dependencies></dependencies>

</task>

<task>

<name>Verify legacy plain-text notes rendering</name>

<action>Verify that pre-v2.3 plain-text notes (without HTML tags) render correctly without showing HTML artifacts. Test that the isRichText() detection works properly.</action>

<verify>
- Load or create a session with plain text (no HTML formatting)
- View the session in the summary modal
- Verify text displays as plain text (not raw HTML tags)
- Test edge case: verify text like "<b>test</b>" is escaped and shows as literal text
</verify>

<done>Legacy plain-text notes (pre-v2.3) render without HTML artifacts</done>

<files>
- src/utils/sanitize.ts
</files>

<dependencies></dependencies>

</task>

<task>

<name>Verify character limit with HTML content</name>

<action>Verify that the 2000 character limit validation works correctly when HTML formatting is present. Confirm the limit behavior is intentional (stores HTML characters).</action>

<verify>
- Type 2000 characters of plain text - verify it saves
- Type 2000 characters with HTML formatting - verify it saves
- Type more than 2000 characters - verify feedback/limitation is shown
- Verify the character count includes HTML tags (intentional behavior)
</verify>

<done>Character limit validation works correctly with HTML content</done>

<files>
- src/hooks/useSessionNotes.ts
</files>

<dependencies></dependencies>

</task>

<task>

<name>Perform end-to-end browser testing</name>

<action>Run comprehensive end-to-end testing to verify all v2.3 features work together in a clean browser environment.</action>

<verify>
- Start focus session - timer starts, NotePanel visible
- Type plain text - text appears in editor
- Apply bold via toolbar button - text becomes bold
-+B shortcut - text Apply bold via Cmd becomes bold
- Remove bold via Cmd+B - bold removed
- Apply bullet list - list created
- Insert link - link appears, clickable
- Complete session - session saves, summary shows formatted text
- View history - session shows in list
- View session details - RichTextDisplay shows formatted notes
- Edit note in history - switch to edit mode, modify, save
- Open in new browser - all data persists correctly
</verify>

<done>All v2.3 features functional in a clean browser test</done>

<files>
- src/components/RichTextEditor.tsx
- src/components/RichTextDisplay.tsx
- src/components/NotePanel.tsx
- src/components/SessionSummary.tsx
- src/components/HistoryDrawer.tsx
</files>

<dependencies></dependencies>

</task>

---

## Implementation Notes

### Keyboard Shortcuts

Tiptap's StarterKit includes keyboard shortcuts by default. The `toggleBold()` command is bound to Cmd+B (Mac) / Ctrl+B (Windows) automatically. No additional configuration should be needed, but verify this works in testing.

### Link Security

The RichTextEditor currently configures:
```typescript
Link.configure({
  openOnClick: false,
  HTMLAttributes: {
    rel: 'noopener noreferrer nofollow',
  },
})
```

The `target="_blank"` attribute is NOT currently set, which means links will open in the same tab by default. Add `target: '_blank'` to the Link configuration if links should open in a new tab.

### Legacy Notes Detection

The `isRichText()` function in sanitize.ts detects HTML tags:
```typescript
export function isRichText(content: string): boolean {
  const htmlPattern = /<[a-z][\s\S]*>/i;
  return htmlPattern.test(content);
}
```

If no HTML tags are detected, content is treated as plain text and HTML entities are escaped.

### Character Limit

The MAX_NOTE_LENGTH = 2000 in useSessionNotes.ts uses `text.length` which counts raw characters in the HTML string. This is intentional - the limit is on stored content size (IndexedDB), and HTML overhead is part of the storage cost.

---

## Dependencies

- Phase 18: Editor Infrastructure (completed)
- Phase 19: Editor Component (completed)
- Phase 20: NotePanel Integration (completed)
- Phase 21: Read-Only Display Integration (completed)

## Files Modified

| File | Change Reason |
|------|---------------|
| src/components/RichTextEditor.tsx | May need to add target="_blank" to Link config |
| src/utils/sanitize.ts | May need to add target attribute during sanitization |
| src/hooks/useSessionNotes.ts | Verify character limit behavior |

## Risk Assessment

- **Low Risk**: Most features already implemented; this is primarily verification
- **Main Uncertainty**: Whether link target="_blank" needs to be added
- **Testing Approach**: Manual browser testing is required due to Tiptap integration
