---
phase: 02-session-management
plan: '01'
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/session.ts
  - src/services/db.ts
  - src/services/sessionStore.ts
autonomous: true
requirements:
  - SESS-02
  - SESS-03
  - SESS-04
  - SESS-05
  - NOTE-03
  - NOTE-05

must_haves:
  truths:
    - "Session data persists in IndexedDB with all required fields"
    - "Session records include id, timestamps, duration, mode, note, and tags"
    - "Tag autocomplete data is stored separately"
  artifacts:
    - path: "src/types/session.ts"
      provides: "SessionRecord and TagData type definitions"
      contains: "interface SessionRecord"
    - path: "src/services/db.ts"
      provides: "Extended IndexedDB schema with sessions and tags stores"
      contains: "sessions:"
    - path: "src/services/sessionStore.ts"
      provides: "Session CRUD operations for IndexedDB"
      exports: ["saveSession", "getSession", "getAllSessions", "saveTag", "getAllTags"]
  key_links:
    - from: "src/services/sessionStore.ts"
      to: "src/services/db.ts"
      via: "initDB()"
      pattern: "db\\.put.*sessions"
---

<objective>
Extend IndexedDB schema with sessions and tags stores, and create session data types.
</objective>

<execution_context>
@/Users/michaelrobert/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelrobert/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@.planning/phases/02-session-management/02-CONTEXT.md
@.planning/phases/02-session-management/02-RESEARCH.md
@src/services/db.ts
@src/types/timer.ts
</context>

<tasks>

<task type="auto">
  <name>Create session types in src/types/session.ts</name>
  <files>src/types/session.ts</files>
  <action>
Create TypeScript interfaces for SessionRecord and TagData:

```typescript
export interface SessionRecord {
  id: string                    // UUID via crypto.randomUUID()
  startTimestamp: string        // ISO timestamp with milliseconds
  endTimestamp: string         // ISO timestamp with milliseconds
  plannedDurationSeconds: number
  actualDurationSeconds: number
  durationString: string        // "MM:SS" format
  mode: 'focus'               // Only focus for history
  startType: 'manual' | 'auto'
  completed: boolean
  noteText: string
  tags: string[]
  createdAt: number            // timestamp for indexing
}

export interface TagData {
  value: string               // tag text
  usageCount: number          // frequency for sorting suggestions
  lastUsed: number            // timestamp
}

export interface SessionNoteState {
  noteText: string
  tags: string[]
  lastSaved: number | null
  saveStatus: 'idle' | 'saving' | 'saved'
}
```

Also add these to timer.ts types if needed for the timer state extension.
  </action>
  <verify>File exists with proper TypeScript exports, no build errors</verify>
  <done>SessionRecord interface includes all required fields: id, startTimestamp, endTimestamp, plannedDurationSeconds, actualDurationSeconds, durationString, mode, startType, completed, noteText, tags</done>
</task>

<task type="auto">
  <name>Extend IndexedDB schema in src/services/db.ts</name>
  <files>src/services/db.ts</files>
  <action>
1. Increment DB_VERSION from 1 to 2
2. Extend PomodoroDBSchema to include sessions and tags stores:

```typescript
interface PomodoroDBSchema extends DBSchema {
  timerState: {
    key: string
    value: TimerStateData
  }
  settings: {
    key: string
    value: SettingsData
  }
  sessions: {
    key: string                    // session UUID
    value: SessionRecord
    indexes: { 'by-date': number } // index for sorting by createdAt
  }
  tags: {
    key: string                    // tag value
    value: TagData
  }
}
```

3. Import SessionRecord and TagData from ../types/session
4. In upgrade function, create sessions store with 'by-date' index, create tags store

Reference the existing upgrade pattern in initDB().
  </action>
  <verify>Build passes, DB version incremented</verify>
  <done>IndexedDB schema includes sessions and tags object stores with proper indexes</done>
</task>

<task type="auto">
  <name>Create sessionStore service in src/services/sessionStore.ts</name>
  <files>src/services/sessionStore.ts</files>
  <action>
Create IndexedDB operations for sessions and tags:

```typescript
import { initDB } from './db'
import { SessionRecord, TagData } from '../types/session'

// Session operations
export async function saveSession(record: SessionRecord): Promise<void> {
  const db = await initDB()
  await db.put('sessions', record)
}

export async function getSession(id: string): Promise<SessionRecord | undefined> {
  const db = await initDB()
  return db.get('sessions', id)
}

export async function getAllSessions(): Promise<SessionRecord[]> {
  const db = await initDB()
  return db.getAllFromIndex('sessions', 'by-date')
}

export async function deleteSession(id: string): Promise<void> {
  const db = await initDB()
  await db.delete('sessions', id)
}

// Tag operations
export async function saveTag(value: string): Promise<void> {
  const db = await initDB()
  const existing = await db.get('tags', value)
  const tagData: TagData = {
    value,
    usageCount: (existing?.usageCount || 0) + 1,
    lastUsed: Date.now(),
  }
  await db.put('tags', tagData)
}

export async function getAllTags(): Promise<TagData[]> {
  const db = await initDB()
  return db.getAll('tags')
}

export async function getTagSuggestions(limit = 10): Promise<string[]> {
  const tags = await getAllTags()
  return tags
    .sort((a, b) => b.usageCount - a.usageCount)
    .slice(0, limit)
    .map(t => t.value)
}
```
  </action>
  <verify>File exists, proper exports, no build errors</verify>
  <done>sessionStore.ts exports: saveSession, getSession, getAllSessions, deleteSession, saveTag, getAllTags, getTagSuggestions</done>
</task>

</tasks>

<verification>
- [ ] src/types/session.ts created with SessionRecord interface
- [ ] db.ts updated with sessions and tags stores, version incremented to 2
- [ ] src/services/sessionStore.ts created with all CRUD operations
- [ ] Build passes without errors
</verification>

<success_criteria>
IndexedDB schema extended to store session records and tag suggestions. All session data fields (id, timestamps, duration, mode, note, tags) can be persisted.
</success_criteria>

<output>
After completion, create `.planning/phases/02-session-management/02-01-SUMMARY.md`
</output>
