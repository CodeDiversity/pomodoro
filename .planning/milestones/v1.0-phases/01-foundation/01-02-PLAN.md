---
phase: 01-foundation
plan: '02'
type: execute
wave: 2
depends_on: [01-01]
files_modified: []
autonomous: true
requirements: [TMR-12, NOTF-01, NOTF-02, NOTF-03, DATA-01, DATA-02, DATA-03]

must_haves:
  truths:
    - "Timer state persists across page refresh"
    - "On corrupted data, reset to defaults"
    - "Audio beep plays when session ends"
    - "Browser notification permission requested on first interaction"
    - "Browser notification sent when session ends (if permitted)"
  artifacts:
    - path: "src/services/db.ts"
      provides: "IndexedDB setup with idb library, schema version, migration stub"
    - path: "src/services/persistence.ts"
      provides: "Save/load timer state with debouncing"
    - path: "src/services/audio.ts"
      provides: "Web Audio API beep using OscillatorNode"
    - path: "src/services/notifications.ts"
      provides: "Permission request and browser notifications"
    - path: "src/hooks/useTimer.ts"
      provides: "Updated to integrate persistence and notifications"
  key_links:
    - from: "src/services/db.ts"
      to: "src/types/timer.ts"
      via: "imports TimerState type"
    - from: "src/hooks/useTimer.ts"
      to: "src/services/persistence.ts"
      via: "calls saveState/loadState"
    - from: "src/hooks/useTimer.ts"
      to: "src/services/audio.ts"
      via: "calls playBeep on session end"
    - from: "src/services/notifications.ts"
      to: "src/services/audio.ts"
      via: "Both called when session ends"
---

<objective>
Implement persistence via IndexedDB and notification services (audio beep + browser notifications) for session completion.
</objective>

<execution_context>
@/Users/michaelrobert/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelrobert/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Set up IndexedDB with idb library</name>
  <files>src/services/db.ts</files>
  <action>
    Create IndexedDB service using idb library (per locked decision in research):
    1. Initialize database 'pomodoro-timer' with version 1
    2. Create object store 'timerState' with keyPath 'id'
    3. Include version number in schema (DATA-01)
    4. Create migration stub function for future schema changes (DATA-02)
    5. Add data validation: check for corrupted data, reset to defaults if invalid

    Schema:
    - Store: timerState
    - Key: 'current'
    - Value: { id, mode, timeRemaining, isRunning, sessionCount, lastTick, autoStart, version }

    Handle incognito mode: wrap IndexedDB access in try/catch, fallback to in-memory if unavailable
  </action>
  <verify>Run `npm run build` to verify service compiles</verify>
  <done>IndexedDB service created with version schema and migration stub</done>
</task>

<task type="auto">
  <name>Create persistence service with debouncing</name>
  <files>src/services/persistence.ts</files>
  <action>
    Create persistence service:
    1. saveTimerState(state): debounced save (every 2 seconds while running)
    2. loadTimerState(): load from IndexedDB on app start
    3. Save: time remaining, current mode, session count, last active timestamp (TMR-12)
    4. On load: calculate elapsed time since lastTick, resume from correct position
    5. Validate loaded data: check required fields, reset if corrupted

    Debounce implementation: use setTimeout, clear previous timeout on each call
    Load on mount: call loadTimerState() in useTimer initialization
  </action>
  <verify>Run `npm run build` to verify service compiles</verify>
  <done>Persistence service handles save/load with debouncing</done>
</task>

<task type="auto">
  <name>Create audio service with Web Audio API</name>
  <files>src/services/audio.ts</files>
  <action>
    Create audio notification service:
    1. Use Web Audio API OscillatorNode (per research - no external files needed)
    2. playBeep(): create oscillator, connect to destination, play 880Hz tone for 200ms
    3. Make beep pleasant but audible: use sine wave, quick attack/decay

    Implementation:
    ```typescript
    const audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    oscillator.connect(audioContext.destination);
    oscillator.frequency.value = 880;
    oscillator.start();
    oscillator.stop(audioContext.currentTime + 0.2);
    ```
  </action>
  <verify>Run `npm run build` to verify service compiles</verify>
  <done>Audio service plays system beep using Web Audio API</done>
</task>

<task type="auto">
  <name>Create browser notification service</name>
  <files>src/services/notifications.ts</files>
  <action>
    Create browser notification service:
    1. requestPermission(): request notification permission on first user interaction (NOTF-02)
    2. showNotification(mode): send browser notification with session type + encouragement (NOTF-03)
       - Title: "Pomodoro Timer"
       - Body: "[Focus Session Complete! Time for a break.]" or "[Break over! Ready to focus?]"
    3. Check permission before sending (only if 'granted')
    4. Call both playBeep and showNotification when session ends

    Per user decision: explicit prompt before first session, not on page load
  </action>
  <verify>Run `npm run build` to verify service compiles</verify>
  <done>Browser notification service requests permission and sends notifications</done>
</task>

<task type="auto">
  <name>Integrate persistence and notifications into useTimer</name>
  <files>src/hooks/useTimer.ts</files>
  <action>
    Update useTimer hook:
    1. On mount: load timer state from IndexedDB
    2. While running: debounced save every 2 seconds
    3. On session end (time reaches 0):
       - Trigger audio beep
       - Trigger browser notification
       - Auto-advance to next session
    4. Handle auto-start preference (DATA-03): if enabled, auto-start next session

    Session end logic:
    - Play beep + send notification
    - Determine next mode (break after focus, focus after break)
    - Update session count (increment after focus session)
    - Reset timer for next session
  </action>
  <verify>Run `npm run build` to verify hook compiles</verify>
  <done>useTimer integrates persistence, audio, and notifications on session end</done>
</task>

</tasks>

<verification>
- Timer state persists across page refresh (TMR-12)
- On corrupted data, reset to defaults (DATA-01)
- Audio beep plays when session ends (NOTF-01)
- Browser notification permission requested on first interaction (NOTF-02)
- Browser notification sent when session ends (NOTF-03)
- Settings stored: durations, auto-start preference (DATA-03)
</verification>

<success_criteria>
- Project builds without errors
- Timer state loads from IndexedDB on refresh
- Timer saves periodically while running
- Session end triggers beep and notification
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
