---
phase: 05-custom-durations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/timer.ts
  - src/services/persistence.ts
  - src/hooks/useTimer.ts
autonomous: true
requirements:
  - DUR-05
  - DUR-06
  - DUR-08
user_setup: []
must_haves:
  truths:
    - Custom durations are saved to IndexedDB when Save is clicked
    - Custom durations are loaded from IndexedDB on page refresh
    - Timer uses custom durations when set
    - Timer resets to new duration when changed while running
  artifacts:
    - path: src/types/timer.ts
: SET      provides_CUSTOM_DURATIONS action type
      contains: type: 'SET_CUSTOM_DURATIONS'
    - path: src/services/persistence.ts
      provides: Duration persistence (save/load)
      exports: saveSettings accepts durations, loadSettings returns durations
    - path: src/hooks/useTimer.ts
      provides: Custom duration application in reducer
      contains: case 'SET_CUSTOM_DURATIONS'
  key_links:
    - from: persistence.ts
      to: IndexedDB settings store
      via: db.put('settings', ...)
      pattern: focusDuration.*shortBreakDuration.*longBreakDuration
    - from: useTimer.ts
      to: TimerState
      via: timerReducer
      pattern: case 'SET_CUSTOM_DURATIONS'
---

<objective>
Implement data layer and timer integration for custom durations.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/05-custom-durations/05-CONTEXT.md
@.planning/phases/05-custom-durations/05-RESEARCH.md
@src/types/timer.ts
@src/services/persistence.ts
@src/hooks/useTimer.ts
</context>

<tasks>

<task type="auto">
  <name>Update AppSettings interface and persistence</name>
  <files>src/services/persistence.ts</files>
  <action>
    1. Update AppSettings interface to include duration fields:
       - focusDuration: number (seconds)
       - shortBreakDuration: number (seconds)
       - longBreakDuration: number (seconds)

    2. Update DEFAULT_SETTINGS with default values in seconds:
       - focusDuration: 25 * 60
       - shortBreakDuration: 5 * 60
       - longBreakDuration: 15 * 60

    3. Update saveSettings function to:
       - Accept full AppSettings with duration fields
       - Save all duration values to IndexedDB (not hardcoded values)

    4. Update loadSettings function to:
       - Return duration values from IndexedDB
       - Return defaults if not set: { focusDuration, shortBreakDuration, longBreakDuration, autoStart }
  </action>
  <verify>TypeScript compiles with no errors for persistence.ts</verify>
  <done>AppSettings includes durations, saveSettings saves them, loadSettings returns them</done>
</task>

<task type="auto">
  <name>Add SET_CUSTOM_DURATIONS action type</name>
  <files>src/types/timer.ts</files>
  <action>
    Add to TimerAction type union:
    { type: 'SET_CUSTOM_DURATIONS'; payload: { focus: number; shortBreak: number; longBreak: number } }
  </action>
  <verify>TypeScript compiles with no errors for timer.ts</verify>
  <done>SET_CUSTOM_DURATIONS action type exists in TimerAction union</done>
</task>

<task type="auto">
  <name>Implement SET_CUSTOM_DURATIONS reducer and load order fix</name>
  <files>src/hooks/useTimer.ts</files>
  <action>
    1. Add reducer case for SET_CUSTOM_DURATIONS:
       - Extract custom durations from action.payload
       - Update state.duration to customDurations[state.mode]
       - Update state.timeRemaining to customDurations[state.mode]
       - Reset isRunning to false, startTime to null, pausedTimeRemaining to null (resets timer per DUR-08)

    2. Add setCustomDurations callback that dispatches SET_CUSTOM_DURATIONS action

    3. Fix load order in useEffect (loadState function):
       - Load settings first, then load timer state
       - After loading timer state, check if custom durations exist in settings
       - If custom durations exist, dispatch SET_CUSTOM_DURATIONS with loaded values
       - This ensures custom durations are applied on page refresh (DUR-06)

    4. Export setCustomDurations in the return object
  </action>
  <verify>TypeScript compiles with no errors for useTimer.ts</verify>
  <done>Timer reducer handles SET_CUSTOM_DURATIONS, custom durations load on init, timer resets when changed while running</done>
</task>

</tasks>

<verification>
- DUR-05: Validation happens in Settings UI (plan 02)
- DUR-06: Custom durations persist via IndexedDB, loaded on page refresh
- DUR-08: Timer resets when custom durations applied while running
</verification>

<success_criteria>
- AppSettings interface includes duration fields
- saveSettings persists durations to IndexedDB
- loadSettings returns durations from IndexedDB
- SET_CUSTOM_DURATIONS action type exists
- Timer reducer handles SET_CUSTOM_DURATIONS (resets timer)
- Custom durations are loaded on app initialization
</success_criteria>

<output>
After completion, create .planning/phases/05-custom-durations/05-01-SUMMARY.md
</output>
