---
phase: 14-data-export-import
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/Settings.tsx
  - src/utils/csvImport.ts
  - src/services/sessionStore.ts
autonomous: true
requirements:
  - IMPT-01
  - IMPT-02
  - IMPT-03
  - IMPT-04
  - IMPT-05
user_setup: []
must_haves:
  truths:
    - "User can import session data from CSV file in Settings view"
    - "File picker only accepts CSV files"
    - "Import validates CSV format and required columns"
    - "Imported sessions are merged without duplicates (by startTimestamp)"
    - "Import shows progress feedback and success/error summary"
  artifacts:
    - path: "src/utils/csvImport.ts"
      provides: "CSV import utility with parsing and validation"
      exports: ["parseCsvFile", "validateSessionRow", "ImportResult"]
    - path: "src/components/Settings.tsx"
      provides: "Import button in Settings Data section"
      contains: "ImportButton, file input, import handler"
  key_links:
    - from: "Settings.tsx"
      to: "csvImport.ts"
      via: "import and call parseCsvFile"
      pattern: "parseCsvFile.*file"
    - from: "csvImport.ts"
      to: "sessionStore.ts"
      via: "call saveSession for valid rows"
      pattern: "saveSession.*SessionRecord"
---

<objective>
Implement data import functionality in Settings view from CSV file
</objective>

<execution_context>
@/Users/michaelrobert/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelrobert/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-data-export-import/14-CONTEXT.md

# Technical Context
- SessionRecord type defined in src/types/session.ts
- sessionStore.ts provides getAllSessions() and saveSession() functions
- Settings.tsx has Data section with Reset All Data button
- File input should use accept=".csv" attribute
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSV import utility</name>
  <files>src/utils/csvImport.ts</files>
  <action>
    Create src/utils/csvImport.ts with:
    - ImportResult interface: { imported: number, skipped: number, errors: string[] }
    - parseCsvFile function that:
      - Reads CSV file via FileReader
      - Parses header row to validate columns: date, duration, mode, notes, tags
      - Parses each data row
      - Validates each row: date required, duration must be positive number, mode must be "focus"
      - Converts to SessionRecord format with generated id and timestamps
      - Batch processes in chunks of 50-100 for progress
    - validateSessionRow function that checks:
      - Required fields present: date, duration, mode
      - duration is positive number
      - mode is "focus"
    - Returns ImportResult with counts and any error messages
  </action>
  <verify>npm run build succeeds</verify>
  <done>parseCsvFile and validateSessionRow functions exist, parse and validate CSV data</done>
</task>

<task type="auto">
  <name>Task 2: Add Import button to Settings Data section</name>
  <files>src/components/Settings.tsx</files>
  <action>
    Modify Settings.tsx (page view mode) to:
    - Add ImportButton styled component (similar to ResetButton, green accent color)
    - Add hidden file input with accept=".csv" attribute and ref
    - Add import state: isImporting (boolean), importResult (ImportResult | null)
    - Add handleImportClick function that triggers file input click
    - Add handleFileChange function that:
      - Calls parseCsvFile with selected file
      - Gets existing sessions via getAllSessions()
      - Checks for duplicates by comparing startTimestamp
      - Saves non-duplicate valid sessions via saveSession()
      - Shows import result toast/alert with imported count and skipped count
    - Place ImportButton next to ResetButton in Data section
  </action>
  <verify>npm run build succeeds</verify>
  <done>Import button appears in Settings Data section, file picker opens on click</done>
</task>

<task type="auto">
  <name>Task 3: Add duplicate detection logic</name>
  <files>src/utils/csvImport.ts</files>
  <action>
    Extend csvImport.ts to:
    - Add getExistingTimestamps function that fetches all sessions and returns Set of startTimestamp values
    - Modify import logic to check startTimestamp against existing sessions
    - Skip rows where startTimestamp already exists (count as duplicate)
    - Include duplicate count in ImportResult
  </action>
  <verify>npm run build succeeds</verify>
  <done>Duplicate sessions are detected and skipped during import</done>
</task>

</tasks>

<verification>
- Import button appears in Settings view Data section
- File picker only accepts CSV files
- Invalid CSV files show error message
- Valid sessions are imported and saved to IndexedDB
- Duplicate sessions (matching startTimestamp) are skipped
- Summary shows imported count and skipped count after import
</verification>

<success_criteria>
- IMPT-01: Import button appears in Settings view
- IMPT-02: File picker accepts CSV files only
- IMPT-03: Import validates CSV format and shows errors for invalid files
- IMPT-04: Imported sessions merged without duplicates (by startTimestamp)
- IMPT-05: Import shows progress feedback and success/error summary
</success_criteria>

<output>
After completion, create `.planning/phases/14-data-export-import/14-02-SUMMARY.md`
</output>
