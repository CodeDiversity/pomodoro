---
phase: 13-streak-tracking
plan: "03"
type: execute
wave: 3
depends_on: ["13-01", "13-02"]
files_modified:
  - src/services/db.ts
  - src/features/session/sessionSlice.ts
  - src/app/hooks.ts
autonomous: true
requirements:
  - STRK-03
  - STRK-07
user_setup: []
must_haves:
  truths:
    - "Streak recalculates after each focus session completes"
    - "Streak data survives browser refresh via IndexedDB"
    - "App loads existing streak data on startup"
  artifacts:
    - path: "src/services/db.ts"
      provides: "IndexedDB schema with streak store (version 4)"
    - path: "src/services/streakStore.ts"
      provides: "saveStreak and loadStreak functions"
    - path: "src/App.tsx"
      provides: "Wires streak recalculation on session complete"
  key_links:
    - from: "App.tsx"
      to: "useStreak"
      via: "handleSessionComplete"
      pattern: "recalculateStreak() called after session save"
---

<objective>
Update IndexedDB schema for streak persistence and integrate streak recalculation on session completion.

Purpose: Add streak store to IndexedDB schema and wire streak recalculation to fire when sessions are saved after completion.

Output: db.ts updated with streak store, session slice updated with streak recalculation trigger
</objective>

<execution_context>
@/Users/michaelrobert/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelrobert/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/13-streak-tracking/13-CONTEXT.md
@.planning/phases/13-streak-tracking/13-RESEARCH.md
@.planning/phases/13-streak-tracking/13-01-SUMMARY.md
@.planning/phases/13-streak-tracking/13-02-SUMMARY.md
@src/services/db.ts
@src/services/sessionStore.ts
@src/types/session.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add streak store to IndexedDB schema</name>
  <files>src/services/db.ts</files>
  <action>
    Update src/services/db.ts:

    1. Update DB_VERSION from 3 to 4
    2. Add StreakData interface:
       ```typescript
       interface StreakData {
         id: string
         currentStreak: number
         bestStreak: number
         lastActiveDate: string | null
         protectionUsed: boolean
         version: number
       }
       ```
    3. Add streak to PomodoroDBSchema:
       ```typescript
       streak: {
         key: string
         value: StreakData
       }
       ```
    4. In upgrade function, add:
       ```typescript
       // Create streak store (v4)
       if (oldVersion < 4) {
         if (!db.objectStoreNames.contains('streak')) {
           db.createObjectStore('streak', { keyPath: 'id' })
         }
       }
       ```
    5. Update clearDatabase() to include streak: await db.clear('streak')
  </action>
  <verify>TypeScript compiles, build succeeds</verify>
  <done>IndexedDB schema updated with streak store, version bumped to 4</done>
</task>

<task type="auto">
  <name>Task 2: Create streak persistence service functions</name>
  <files>src/services/streakStore.ts</files>
  <action>
    Create src/services/streakStore.ts:

    1. Import { initDB } from './db'
    2. Define STREAK_KEY = 'current'

    3. `saveStreak(streak: Omit<StreakData, 'id' | 'version'>)`:
       - Get DB
       - Put to 'streak' store with id: STREAK_KEY, version: 1

    4. `loadStreak(): Promise<StreakData | undefined>`:
       - Get DB
       - Get from 'streak' store by STREAK_KEY

    Export StreakData interface and both functions.
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>streakStore.ts provides save/load functions for IndexedDB streak data</done>
</task>

<task type="auto">
  <name>Task 3: Update streak middleware to use streakStore</name>
  <files>src/features/streak/streakMiddleware.ts</files>
  <action>
    Update src/features/streak/streakMiddleware.ts:

    1. Import { saveStreak } from '../../services/streakStore'
    2. In middleware, on 'streak/updateStreak' action:
       - Extract streak data from action payload
       - Call saveStreak() with the data
       - Use try/catch for error handling (log errors but don't crash)

    Keep existing debounce pattern.
  </action>
  <verify>TypeScript compiles, build succeeds</verify>
  <done>Streak middleware persists to IndexedDB via streakStore</done>
</task>

<task type="auto">
  <name>Task 4: Integrate streak recalculation on session completion</name>
  <files>src/hooks/useTimer.ts</files>
  <action>
    Update src/hooks/useTimer.ts:

    1. Import { useStreak } from '../features/streak/useStreak' (will be created in 13-01)
    2. Inside handleSessionComplete function, after session is saved:
       - Call recalculateStreak() from useStreak hook
       - This ensures streak updates after each focus session completes

    Note: We cannot import useStreak directly in useTimer since useStreak is a hook.
    Instead, the integration happens at a higher level - in App.tsx where useTimer is called.
  </action>
  <verify>TypeScript compiles, build succeeds</verify>
  <done>Session completion triggers streak recalculation</done>
</task>

<task type="auto">
  <name>Task 5: Wire streak recalculation in App.tsx</name>
  <files>src/App.tsx</files>
  <action>
    Update src/App.tsx:

    1. Import { useStreak } from './features/streak/useStreak'
    2. In App component, call useStreak() to get recalculateStreak function
    3. In handleSessionComplete function (around line 349-361), after session is saved:
       - Call recalculateStreak() to update streak after focus session completion

    This ensures streak recalculates when a focus session is completed.
  </action>
  <verify>TypeScript compiles, build succeeds</verify>
  <done>App.tsx triggers streak recalculation on session complete</done>
</task>

</tasks>

<verification>
- [ ] npm run build succeeds without errors
- [ ] Streak data persists to IndexedDB after updates
- [ ] Streak recalculates after session completion
- [ ] App loads streak from IndexedDB on startup
</verification>

<success_criteria>
- Streak data persisted to IndexedDB (STRK-07)
- Streak recalculates after focus session completes (STRK-03)
- Streak loads from IndexedDB on app initialization (per CONTEXT.md)
</success_criteria>

<output>
After completion, create .planning/phases/13-streak-tracking/13-03-SUMMARY.md
</output>
