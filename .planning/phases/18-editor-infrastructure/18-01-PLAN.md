---
phase: 18-editor-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true
requirements:
  - INF-01
  - INF-02
  - INF-03

must_haves:
  truths:
    - "Tiptap and dompurify packages install without conflicts"
    - "RichTextDisplay component renders HTML safely without XSS"
    - "Legacy plain-text notes display without HTML artifacts"
    - "Session notes can store rich text HTML"
  artifacts:
    - path: "src/components/RichTextDisplay.tsx"
      provides: "Read-only rendering of sanitized HTML notes"
      min_lines: 40
    - path: "src/utils/sanitize.ts"
      provides: "dompurify configuration and sanitization function"
      min_lines: 20
    - path: "package.json"
      provides: "Updated dependencies with tiptap and dompurify"
      contains: "@tiptap/react"
  key_links:
    - from: "RichTextDisplay.tsx"
      to: "sanitize.ts"
      via: "import and use sanitizeHtml function"
      pattern: "import.*sanitize"
---

<objective>
Install rich text dependencies and create foundation components with XSS sanitization.

Purpose: Provide the infrastructure for rich text notes (Phase 19-22) with proper security. The RichTextDisplay component will be used in Phase 21 for read-only display in SessionSummary and HistoryDrawer.

Output: Installed packages, RichTextDisplay component, sanitization utility.
</objective>

<execution_context>
@/Users/michaelrobert/.claude/get-shit-done/workflows/execute-plan.md
@/Users/michaelrobert/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-editor-infrastructure/18-CONTEXT.md
@src/types/session.ts
</context>

<tasks>

<task type="auto">
  <name>Install rich text and sanitization dependencies</name>
  <files>package.json</files>
  <action>
    Run npm install to add the following packages:
    - @tiptap/react
    - @tiptap/starter-kit
    - @tiptap/extension-link
    - dompurify
    - @types/dompurify

    Use: npm install @tiptap/react @tiptap/starter-kit @tiptap/extension-link dompurify @types/dompurify

    Verify installation completes without conflicts and packages appear in package.json dependencies.
  </action>
  <verify>npm install completes without errors, package.json shows new dependencies</verify>
  <done>All 5 packages installed successfully</done>
</task>

<task type="auto">
  <name>Create dompurify sanitization utility</name>
  <files>src/utils/sanitize.ts</files>
  <action>
    Create src/utils/sanitize.ts with:

    1. Import DOMPurify from 'dompurify'
    2. Create strict config allowing only:
       - Basic formatting: strong, b, em, i, u, s, strike
       - Lists: ul, ol, li
       - Structure: p, br
       - Links: a (with href attribute only)
    3. Strip ALL style attributes and inline CSS
    4. Add 'data' to allowlist if needed for editor state

    5. Export functions:
       - sanitizeHtml(html: string): string - returns sanitized HTML
       - isRichText(content: string): boolean - detects if content has HTML tags
       - escapePlainText(text: string): string - escapes HTML entities for plain text

    Use type: import DOMPurify from 'dompurify' (not default)
  </action>
  <verify>File created with 3 exported functions, TypeScript compiles without errors</verify>
  <done>Sanitization utility with strict XSS protection created</done>
</task>

<task type="auto">
  <name>Create RichTextDisplay component</name>
  <files>src/components/RichTextDisplay.tsx</files>
  <action>
    Create src/components/RichTextDisplay.tsx:

    1. Props interface:
       - content: string (HTML string or plain text)
       - className?: string (optional styling override)

    2. Logic:
       - Use isRichText() to detect if content has HTML tags
       - If rich text: sanitize with sanitizeHtml(), render with dangerouslySetInnerHTML
       - If plain text: escape with escapePlainText(), render as plain text (no HTML)

    3. Styling (styled-components):
       - Container: use app font, line-height 1.6
       - Links: app accent color, underline on hover, target="_blank" rel="noopener noreferrer"
       - Lists: proper indent for ul/ol
       - Paragraphs: margin-bottom

    4. Handle empty content gracefully (return null or placeholder)

    Import colors from ./ui/theme if available, otherwise use #136dec for links.
  </action>
  <verify>Component renders sanitized HTML correctly, plain text without artifacts, TypeScript compiles</verify>
  <done>RichTextDisplay component ready for Phase 21 integration</done>
</task>

</tasks>

<verification>
Run the following to verify the phase is complete:

1. Build succeeds: npm run build
2. No TypeScript errors: npx tsc --noEmit
3. RichTextDisplay imports correctly in a test file
</verification>

<success_criteria>
1. Tiptap dependencies installed without conflicts (@tiptap/react, @tiptap/starter-kit, @tiptap/extension-link)
2. dompurify installed and configured for HTML sanitization
3. RichTextDisplay component renders sanitized HTML in read-only mode
4. Existing plain-text notes display correctly without formatting artifacts
5. Session notes can store and render rich text HTML (autosave foundation)
</success_criteria>

<output>
After completion, create `.planning/phases/18-editor-infrastructure/18-01-SUMMARY.md`
</output>
